\section{Invariance}
\ptitle{Limitations of Linear Controllers}

The region in which a linear controller \textit{never} violates state and input constraints is very limited.
% TODO: I think the regions represent the feasible set, right? I.e. the x1 and x2 axis are x_{1,0} and x_{2,0}. If true, uncomment the following ;)
% The range of initial conditions for which a linear controller \textit{never} violates state and input constraints is very limited.
\begin{center}
    \includegraphics[width = 0.5\linewidth]{05_LQR_limitations.png}
\end{center}
Nonlinear control (MPC) can be used to increase the region, for which constraints can always be satisfied.

\subsection{Invariance}
The concept of invariance is used to access constraint satisfaction, for
\begin{itemize}
    \item an autonomous system $x(k + 1) = g(x(k))$
    \item or a CL system $x(k + 1) = g(x(k), \kappa(x(k)))$, given a controller $\kappa$.
\end{itemize}

\subsubsection{Invariant Sets}
\ptitle{Positively Invariant Set}

A set $\mathcal{O}$ is said to be a positively invariant set for an autonomous system if
\begin{equation*}
    x(k) \in \mathcal{O} \Rightarrow x(k + 1) \in \mathcal{O}, \quad \forall k \in \{0, 1, \dots \}
\end{equation*}
Hence, if $\mathcal{O}$ is within the constraints, it provides a set of initial states from which the trajectory will \textbf{never} violate the system constraints.

\newpar{}
\ptitle{Maximal Positively Invariant Set $\mathcal{O}_\infty$}

The set $\mathcal{O}_\infty \subset \mathcal{X}$ is the maximal positively invariant set with respect to $\mathcal{X}$ if $\mathcal{O}_\infty$ is positively invariant and $\mathcal{O}_\infty$ contains all positively invariant sets.
\newpar{}
$\mathcal{O}_\infty$ is the set of \textbf{all} states for which the system will remain feasible once in $\mathcal{O}_\infty$.

\newpar{}
\ptitle{Geometric Condition for Invariance}

A set $\mathcal{O}$ is a positively invariant set if and only if
\begin{equation*}
    \mathcal{O} \subseteq \text{pre}(\mathcal{O})
\end{equation*}
Note that
\begin{equation*}
    \mathcal{O} \subseteq \text{pre}(\mathcal{O}) \iff \text{pre}(\mathcal{O})\cap \mathcal{O} = \mathcal{O}
\end{equation*}
\subsubsection{Pre-Sets}

Given a set $S$ and the dynamic system $x(k + 1) = g(x(k))$, the pre-set of $S$ is the set of states that evolve into the target set $S$ in \textbf{one} time step:
\begin{equation*}
    \text{pre}(S) := \{x \mid g(x) \in S \}
\end{equation*}

\newpar{}
\ptitle{Linear Autonomous Systems}

Given $x(k + 1) = A x(k)$, the condition is
\begin{equation*}
    \text{pre}(S) := \{x \mid A x \in S \}
\end{equation*}
In the constraint case $S := \{x \mid F x \leq f \}$, this yields
\begin{equation*}
    \text{pre}(S) = \{x \mid F A x \leq f \}
\end{equation*}

\subsubsection{Computing Invariant Sets}\label{ssec:computing_invariant_sets}
A conceptual algorithm to calculate invariant sets is
\begin{algorithmic}
    \State{} \textbf{Input:} $g$, $X$
    \State{} \textbf{Output:} $\mathcal{O}_\infty$
    \State{} $\Omega_0 \gets X$
    \While{true}
    \State{} $\Omega_{i+1} \gets \text{pre}(\Omega_i) \cap \Omega_i$
    \If{$\Omega_{i+1} = \Omega_i$}
    \State{} \textbf{return} $\mathcal{O}_\infty = \Omega_i$
    \EndIf{}
    \EndWhile{}
\end{algorithmic}
This algorithm generates the set sequence $\{\Omega_i\}$ satisfying $\Omega_{i+1} \subseteq \Omega_i$ for all $i \in \mathbb{N}$ and terminates when $\Omega_{i+1} = \Omega_i$, where $\Omega_i$ is the maximal positively invariant set $\mathcal{O}_\infty$ for $x(k + 1) = g(x(k))$.

\subsection{Control Invariance}
\subsubsection{Control Invariant Sets}
A set $\mathcal{C} \subseteq \mathcal{X}$ is said to be a control invariant set if
\begin{gather*}
    x(k) \in \mathcal{C} \Rightarrow \exists u(k) \in \mathcal{U}\\
    \text{such that } g(x(k), u(k)) \in \mathcal{C} \text{ for all } k \in \mathbb{N}^+
\end{gather*}
If this set is feasible (wrt.\ constraints) then we can be sure that the constraints will be satisfied for all time under the given control law.

\newpar{}
\ptitle{Maximal Control Invariant Set $\mathcal{C}_\infty$}

The set $\mathcal{C}_\infty$ is said to be the maximal control invariant set for the system $x(k + 1) = g(x(k), u(k))$ subject to the constraints $(x, u) \in \mathcal{X} \times \mathcal{U}$ if it is control invariant and \textbf{contains all control invariant sets} contained in $\mathcal{X}$.
\newpar{}
For all states contained in the maximal control invariant set $\mathcal{C}_\infty$, there exists a control law such that the system constraints are never violated.

\subsubsection{Conceptual Calculation of Control Invariant Sets}

The concept of a pre-set extends to systems with exogenous inputs:
\begin{equation*}
    \text{pre}(S) := \{x \mid \exists u \in \mathcal{U} \text{ s.t. } g(x, u) \in S \}
\end{equation*}
A set $\mathcal{C}$ is a control invariant set if and only if $\mathcal{C} \subseteq \text{pre}(\mathcal{C})$.

\newpar{}
The same algorithm as for positively invariant sets can be used but the calculation of the pre-set is much more complicated.


\ptitle{Preset Computation for Constrained LTI System}

Consider the system $x(k + 1) = A x(k) + B u(k)$ under the constraints
\begin{align*}
    u(k) \in \mathcal{U} & := \{u \mid G u \leq g \} \\
    S                    & := \{x \mid F x \leq f \}
\end{align*}
The preset can be computed as
\begin{align*}
    \text{pre}(S) & = \{x \mid \exists u \in \mathcal{U}, \; Ax + Bu \in S \}                                                                                                            \\
                  & = \{x \mid \exists u \in \mathcal{U}, \; F A x + F B u \leq f \}                                                                                                     \\
                  & = \left\{ x \mid \exists u, \begin{bmatrix} F A & F B \\ 0 & G \end{bmatrix} \begin{bmatrix} x \\ u \end{bmatrix} \leq \begin{bmatrix} f \\ g \end{bmatrix} \right\}
\end{align*}
which is a \textbf{projection operation}.

\newpar{}
\ptitle{Properties}

\begin{itemize}
    \item An entire set of states can map into each point
    \item The pre-set is a lot larger (positive), but much more difficult to compute
    \item The maximum control invariant set is the best any controller can do.
\end{itemize}

\paragraph{Usefulness}

If one can compute a control invariant set, it provides a direct method for synthesizing a control law that will satisfy constraints. However, calculating the maximal control invariant set is often too complex in the case of linear systems and even more difficult for nonlinear ones. MPC implicitly describes a (suboptimal) control invariant set such that it's easy to represent and compute.

\newpar{}
\ptitle{Linear System / Polyhedral Constraints}

In this special case one can e.g.\ choose
\begin{itemize}
    \item Polyhedral invariant set (can represent maximum control invariant set, resulting QP can be very complex due to many inequalities)
    \item Ellipsoidal invariant set (smaller than polyhedral, but easier to compute, resulting quadratically constrained QP has fixed complexity)
\end{itemize}

\paragraph{Control Laws from Control Invariant Sets}

Let $\mathcal{C}$ be a control invariant set for the system $x(k + 1) = g(x(k), u(k))$.
\newpar{}
A control law $\kappa(x(k))$ guarantees that the system $x(k + 1) = g(x(k), \kappa(x(k)))$ will satisfy the state constraints for all time if it respects the control invariant set, i.e.:
\begin{equation*}
    g(x, \kappa(x)) \in \mathcal{C} \quad \forall x \in \mathcal{C}
\end{equation*}
Therefore, we can synthesize a control law from a control invariant set by solving the following \textbf{optimization problem}:
\begin{equation*}
    \kappa(x) := \arg\min \{ f(x, u) \mid g(x, u) \in \mathcal{C},\; u \in \mathcal{U} \},
\end{equation*}
where $f$ is any function (including $f(x, u) = 0$).
\newpar{}
\textbf{Note}: This ensures that the system will satisfy the constraints, but it does not guarantee convergence.

\subsection{Computation of Simple Invariant Sets}
This subsection specifies how to compute the intersection of two sets and the equality test needed in~\ref{ssec:computing_invariant_sets}.      % TODO: The ellipsoid subsubsection doesn't match this description. Some restructuring needed.
\subsubsection{Polytopes}
\paragraph{Intersection}
Computing polytope intersections in vertex form is difficult. In inequality form however, one directly gets
\begin{equation*}
    S \cap T = \left\{x \Bigg|\begin{bmatrix}
        C \\D
    \end{bmatrix}x \leq \begin{bmatrix}
        c \\d
    \end{bmatrix}\right\}
\end{equation*}

\paragraph{Equality Test (Subset Test)}
$P=\{x\mid Cx\leq c\}$ is a subset of $Q=\{x\mid Dx\leq d\}$ if for each row, the \textbf{support function} is a subset of $D$:
\begin{equation*}
    h_P(D_i) \leq d_i
\end{equation*}
where the support (extremum of $P$ in direction $D_i$) is defined as
\begin{align*}
    h_p(D_i) :=     & \max_x D_i x \\
    \mathrm{s.t.}\; & Cx\leq c
\end{align*}
\begin{center}
    \includegraphics[width = 0.6\linewidth]{05_support_fnc.png}
\end{center}
\subsubsection{Ellipsoids}
Invariant ellipsoidal sets with its center in the origin, can directly be computed from Lyapunov functions.

\newpar{}
If $V:\mathbb{R}^d\to\mathbb{R}$ is a Lyapunov function for the system $x(k+1)=g(x(k))$, then the sublevel set
\begin{equation*}
    Y = \{x\mid V(x)\leq \alpha\}
\end{equation*}
is an invariant set for all $\alpha \geq 0$.

\paragraph{Linear Systems}
For linear systems $x(k+1)=Ax(k)$, the Lyapunov function $V(x)=x^\top Px$ (with $P\succ 0$  and $A^\top PA-P \prec 0$) yields the ellipsoidal invariant set
\begin{equation*}
    Y_\alpha = \left\{x\mid x^\top Px\leq \alpha\right\} \subset \mathcal{X}= \left\{x\mid Fx\leq f\right\}
\end{equation*}

\newpar{}
\ptitle{Maxmium Invariant Set}

If we want to find the largest such $Y_\alpha$, we must solve
\begin{gather*}
    \max_{\alpha}\alpha \\
    \text{subj. to }h_{Y_{\alpha}}(F_{i})\leq f_{i} \\
    \forall i\in\{1,...,n\}
\end{gather*}
with the support of an ellipse
\begin{equation*}
    h_{Y_\alpha}(F_i)=\|P^{-1/2}F_i^T\|\sqrt{\alpha}
\end{equation*}
The largest ellipse $Y_\alpha$ in a polytope $\mathcal{X}$ can now be computed with a 1D optimization problem
\begin{equation*}
    \alpha^* = \min_{i\in \{1,\ldots, n\}} \frac{f_i^2}{F_i P^{-1} F_i^\top}
\end{equation*}

\textbf{Note} that this only computes the largest ellipsoid with the center in the origin and a fixed shape $P$ (left image).
\begin{center}
    \includegraphics[width = \linewidth]{05_max_Lyapunov_elipsoid.png}
\end{center}


\section{Constraint Finite Time Optimal Control (CFTOC)}

\subsection{Constraint Linear Optimal Control}

For a linear model the CFTOC problem is given by
\begin{align*}
    J^*(x(k)) =            & \min_U \: I_f(x_N) + \sum_{i=0}^{N-1}I(x_i,u_i)                    \\
    \text{subject to}\quad & x_{i+1} = Ax_i +Bu_i, \quad i = 0, \ldots, N-1                     \\
                           & x_i \in \mathcal{X}, u_i \in \mathcal{U}, \quad i = 0, \ldots, N-1 \\
                           & x_N \in \mathcal{X}_f                                              \\
                           & x_0 = x(k)
\end{align*}
where $I(x_i,u_i)$ is the stage cost, $I_f(x_N)$ represents an approximation of the tail cost and $\mathcal{X}_f$ of the tail constraints, respectively. $N$ is the time horizon and $\mathcal{X,U,X}_f$ are polyhedral regions.

\newpar{}
\ptitle{Feasible Set}

The feasible set describes a set of initial states for which the optimal control problem is feasible. It is defined only by the constraints and not by the cost:
\begin{align*}
    \mathcal{X}_N = & \left\{ x_0 \in \mathbb{R}^n | \exists\left(u_0, \ldots, u_{N-1}\right) \text{such that } x_i\in\mathcal{X}, u_i\in\mathcal{U} \right. \\
                    & \left.i=0,\ldots, N-1, x_N\in\mathcal{X}_f, \text{where } x_{i+1}=Ax_i + Bu_i\right\}
\end{align*}

Or in other words, the feasible set describes initial conditions from which it is possible to get into the final set $\mathcal{X}_f$ within $N-1$ steps.
\newpar{}
In the convex case, the convex hull of a set of feasible solutions can be used as approximation of $\mathcal{X}_N$.

\subsubsection{Quadratic Cost CFTOC}

The cost function that incorporates a squared euclidean norm is composed of
\begin{align*}
    I_f(x_N)   & = x_N^T P x_N                     \\
    I(x_i,U_i) & = x_i^\top Q x_i + u_i^\top R u_i
\end{align*}
with $P\succeq0, Q\succeq0, R\succ0$.

\newpar{}

The \textbf{quadratic cost CFTOC problem}
\begin{align*}
    J^*(x(k)) =            & \min_U \: x_N^T P x_N + \sum_{i=0}^{N-1}x_i^\top Q x_i + u_i^\top R u_i \\
    \text{subject to}\quad & x_{i+1} = Ax_i +Bu_i, \quad i = 0, \ldots, N-1                          \\
                           & x_i \in \mathcal{X}, u_i \in \mathcal{U}, \quad i = 0, \ldots, N-1      \\
                           & x_N \in \mathcal{X}_f                                                   \\
                           & x_0 = x(k)
\end{align*}

can be transformed into a QP problem
\begin{align*}
    \min_{z\in\mathbb{R}^n} & \frac{1}{2}z^\top Hz + q^\top z + r \\
    \text{subject to}\quad  & Gz \leq h                           \\
                            & Az = b
\end{align*}

either with (\ref{cftoc_QP_with_subs}) or without (\ref{cftoc_QP_without_subs}) substitution of the future states $X$.

\newpar{}
\ptitle{Notation}

In the following we use
\begin{itemize}
    \item $n_x$: dimension of state space
    \item $n_u$: dimension of input
    \item $n_z$: dimension of $z$ for~\ref{cftoc_QP_without_subs}
    \item $n_w$: dimension of $w$ for~\ref{cftoc_QP_with_subs}
    \item $n_{in,x}$: number of state inequality constraints
    \item $n_{in,u}$: number of input inequality constraints
\end{itemize}

\paragraph{Construction of QP Without Substitution}\label{cftoc_QP_without_subs}

This approach keeps the state equations as equality constraints. The CFTOC problem is transformed into the QP problem parametrized in the initial condition $x(k)$  % TODO: In the lecture they say this approach would be more efficient. In terms of comp. cost or just for matrix bastli?
\begin{align*}
    J^*(x(k)) =            & \min_{z}\begin{bmatrix}
                                         z^\top & x(k)
                                     \end{bmatrix}
    \underbrace{\begin{bmatrix}
                        \bar{H} & 0 \\
                        0       & Q
                    \end{bmatrix}}_{\tilde{H}}
    \begin{bmatrix}
        z^\top & {x(k)}^\top
    \end{bmatrix}^\top                                       \\
    \text{subject to}\quad & G_{in} z \leq w_{in} +E_{in} x(k) \\
                           & G_{eq} z = E_{eq} x(k)
\end{align*}
where
\begin{equation*}
    z = \begin{bmatrix}
        x_1^\top & \cdots & x_N^\top & u_0^\top & \cdots & u_{N-1}^\top
    \end{bmatrix}^\top \in \mathbb{R}^{n_z = N(n_x + n_u)}
\end{equation*}
and $\tilde{H}\in \mathbb{R}^{(n_z+n_x) \times (n_z+n_x)} \geq 0$ as $J(x(k),U) \geq 0$ by assumption. % TODO: I added H>=0 also here (we had it only in the substitution paragraph but I think it's >=0 in both cases).

\newpar{}
\ptitle{Cost}

The cost submatrix $\bar{H}$ is
\begin{equation*}
    \bar{H} = \left[
        \begin{array}{cccc|cccc} % ChkTex 44
            Q &        &   &   &   &        &   \\
              & \ddots &   &   &   &        &   \\
              &        & Q &   &   &        &   \\
              &        &   & P &   &        &   \\
            \hline % ChkTex 44
              &        &   &   & R &        &   \\
              &        &   &   &   & \ddots &   \\
              &        &   &   &   &        & R
        \end{array}
        \right]
\end{equation*}

This can be constructed using the Matlab function

\begin{small}
    \texttt{barH = blkdiag(kron(eye(N-1),Q),P,kron(eye(N),R))}
\end{small}

\newpar{}
\ptitle{Equality Constraints}

The equalities are given from the system dynamics
\begin{equation*}
    x_{i+1} = Ax_i + Bu_i
\end{equation*}
can be rewritten as
\begin{equation*}
    G_{eq} z = E_{eq} x(k)
\end{equation*}
with
    {\small
        \begin{gather*}
            G_{eq} = \left[
                \begin{array}{cccc|cccc} % ChkTex 44
                    I  &   &        &   & -B &    &        &    \\
                    -A & I &        &   &    & -B &        &    \\
                       &   & \ddots &   &    &    & \ddots &    \\
                       &   & -A     & I &    &    &        & -B
                \end{array}
                \right] \in \mathbb{R}^{N\cdot n_x \times n_z}\\
            E_{eq} = \begin{bmatrix}
                A^\top & 0 & \cdots & 0
            \end{bmatrix}^\top \in \mathbb{R}^{N\cdot n_x \times n_x}
        \end{gather*}
    }

\newpar{}
\ptitle{Inequality Constraints}

The inequality constraints
\begin{gather*}
    \mathcal{X} = \{x|A_x x \leq b_x\} \\
    \mathcal{U} = \{u|A_u u \leq b_u\} \\
    \mathcal{X}_f = \{x|A_f x \leq b_f\}
\end{gather*}
can be rewritten as
\begin{equation*}
    G_{in} z \leq w_{in} + E_{in} x(k)
\end{equation*}
with
\begin{align*}
    G_{in} & \in \mathbb{R}^{(n_{in,x}+n_{in,u})\times n_z} \\
           & =\left[
        \begin{array}{cccc|cccc} % ChkTex 44
            0   &        &     &     & 0   &        &        &     \\
            \hline % ChkTex 44
            A_x &        &     &     & 0   &        &        &     \\
                & \ddots &     &     &     & \ddots &        &     \\
                &        & A_x &     &     &        & 0      &     \\
                &        &     & A_f &     &        &        & 0   \\
            \hline % ChkTex 44
            0   &        &     &     & A_u &        &        &     \\
                & \ddots &     &     &     & A_u    &        &     \\
                &        & 0   &     &     &        & \ddots &     \\
                &        &     & 0   &     &        &        & A_u
        \end{array}
    \right]                                                 \\
\end{align*}
\begin{gather*}
    w_{in}\in \mathbb{R}^{(n_{in,x}+n_{in,u})\times 1}, \quad E_{in} \in \mathbb{R}^{(n_{in,x}+n_{in,u})\times n_x}\\
    w_{in} = \begin{bmatrix}
        b_x                    \\
        \cmidrule(lr){1-1} b_x \\
        \vdots                 \\
        b_x                    \\
        b_f                    \\
        \cmidrule(lr){1-1} b_u \\
        b_u                    \\
        \vdots                 \\
        b_u                    \\
        b_u
    \end{bmatrix}, \quad
    E_{in} =\begin{bmatrix}
        -A_x                 \\
        \cmidrule(lr){1-1} 0 \\
        \vdots               \\
        0                    \\
        0                    \\
        \cmidrule(lr){1-1} 0 \\
        0                    \\
        \vdots               \\
        0                    \\
        0
    \end{bmatrix}
\end{gather*}

\paragraph{Construction of QP With Substitution}\label{cftoc_QP_with_subs}

The future states are only dependent on the current state and the applied input sequence. Hence they can be uniquely constructed from these and can therefore be substituted. To do so the same method as for the LQR batch approach (\ref{unconst_lqr}) is used:
\begin{align*}
    \underbrace{\begin{bmatrix}
                        x_1    \\
                        x_2    \\
                        \vdots \\
                        x_N
                    \end{bmatrix}}_{X \in \mathbb{R}^{N\cdot n_x}} = &
    \underbrace{\begin{bmatrix}
                        A      \\
                        A^2    \\
                        \vdots \\
                        A^N
                    \end{bmatrix}}_{S^x} x(k) +
    \underbrace{\begin{bmatrix}
                        B        & 0      & \cdots & 0 \\
                        AB       & B      & \cdots & 0 \\
                        \vdots   & \ddots & \ddots & 0 \\
                        A^{N-1}B & \cdots & AB     & B
                    \end{bmatrix}}_{S^u \in \mathbb{R}^{(N\cdot n_x)\times (N\cdot n_u)}}
    \underbrace{\begin{bmatrix}
                        u_0    \\
                        u_1    \\
                        \vdots \\
                        u_{N-1}
                    \end{bmatrix}}_{U}                                      \\
    X =                                              & S^x x(k) + S^u U
\end{align*}

\newpar{}
\ptitle{Cost}

By substituting the $X$ vector in the cost function of~\ref{cftoc_QP_without_subs}, one can rewrite the cost only depending on $U$ and $x(k)$ (parametrized in the initial condition)
\begin{align*}
    J^*(x(k), U)=          & \min_{U}\begin{bmatrix}
                                         U^\top & {x(k)}^\top
                                     \end{bmatrix}
    \underbrace{\begin{bmatrix}
                        H & F^\top \\
                        F & Y
                    \end{bmatrix}}_{\tilde{H}}
    {\begin{bmatrix}
         U^\top & {x(k)}^\top
     \end{bmatrix}}^\top                                 \\
    \text{subject to}\quad & GU \leq w + Ex(k)
\end{align*}
where $\tilde{H}\in \mathbb{R}^{(N\cdot n_u + n_x)\times (N\cdot n_u + n_x)}\geq 0$ since $J(x(k),U) \geq 0$ by assumption.

\newpar{}
\ptitle{Inequality Constraints}

The inequality constraints
\begin{gather*}
    \mathcal{X} = \{x|A_x x \leq b_x\} \\
    \mathcal{U} = \{u|A_u u \leq b_u\} \\
    \mathcal{X}_f = \{x|A_f x \leq b_f\}
\end{gather*}
also encode the equality constraints and can be rewritten as
\begin{equation*}
    GU\leq w + Ex(k)
\end{equation*}
with
\begin{align*}
    G & \in \mathbb{R}^{(n_{in,u} + n_{in,x})\times (N\cdot n_u)} \\
      & = \begin{bmatrix}
              A_u                   & 0             & \cdots & 0      \\
              0                     & A_u           & \cdots & 0      \\
              \vdots                & \vdots        & \ddots & \vdots \\
              0                     & 0             & \cdots & A_u    \\
              \cmidrule(lr){1-4}  0 & 0             & \cdots & 0      \\
              A_x B                 & 0             & \cdots & 0      \\
              A_x AB                & A_x B         & \cdots & 0      \\
              \vdots                & \vdots        & \ddots & \vdots \\
              A_f A^{N-1} B         & A_f A^{N-2} B & \cdots & A_f B
          \end{bmatrix}
\end{align*}
\begin{gather*}
    w \in \mathbb{R}^{(n_{in,u} + n_{in,x})\times 1},\quad E \in \mathbb{R}^{(n_{in,u} + n_{in,x})\times n_x}\\
    w = \begin{bmatrix}
        b_u                    \\
        b_u                    \\
        \vdots                 \\
        b_u                    \\
        \cmidrule(lr){1-1} b_x \\
        b_x                    \\
        b_x                    \\
        \vdots                 \\
        b_f
    \end{bmatrix}, \quad
    E = \begin{bmatrix}
        0                       \\
        0                       \\
        \vdots                  \\
        0                       \\
        \cmidrule(lr){1-1} -A_x \\
        -A_x A                  \\
        -A_x A^2                \\
        \vdots                  \\
        -A_f A^N
    \end{bmatrix}
\end{gather*}
Note that $w$ is structurally different to $w_{in}$ from~\ref{cftoc_QP_without_subs}.

\paragraph{State Feedback Solution}

%TODO: Lecture 5 

\subsubsection[1-Norm and Inf-Norm Cost]{1-Norm and $\infty$-Norm Cost CFTOC}

The cost function that incorporates the $p=1$ or $p=\infty$ norm is composed of
\begin{align*}
    I_f(x_N)   & = {\lVert Px_N \rVert}_p                          \\
    I(x_i,U_i) & = {\lVert Qx_i \rVert}_p + {\lVert Ru_i \rVert}_p
\end{align*}
with $P,Q,R$ having full column rank.

%TODO: Lecture 5 

\paragraph{Construction of LP with Substitution}

%TODO: Lecture 5 

\paragraph{State Feedback Solution}

%TODO: Lecture 5 